{% extends './layout/base.njk' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h4 class="page-title">상품 등록</h4>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <form action="" method="POST" id="form" enctype="multipart/form-data">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="category1">1차 카테고리 <span class="text-danger">*</span></label>
                                    <select class="form-control category" data-toggle="select2" name="category1" id="category1" data-next="#category2" required>
                                        <option value="">선택</option>
                                        {% for obj in categories %}
                                            <option value="{{ obj.id }}" {% if obj.id === product.Categories[0].id %} selected {% endif %} >{{ obj.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <span class="font-13 text-muted">1차 카테고리를 필수 선택요소 입니다.</span>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="category2">2차 카테고리</label>
                                    <select class="form-control category" data-toggle="select2" name="category2" id="category2" data-next="#category3">
                                    </select>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="category3">3차 카테고리</label>
                                    <select class="form-control category" data-toggle="select2" name="category3" id="category3">
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="title">상품명 <span class="text-danger">*</span></label>
                                    <input class="form-control" type="text" placeholder="상품명" name="title" id="title" value="{{ product.name }}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="customer_price">판매가 <span class="text-danger">*</span></label>
                                    <input class="form-control" type="number" placeholder="판매가" name="customer_price" id="customer_price" value="{{ product.customer_price }}">
                                    <span class="font-13 text-muted">고객이 구매하는 가격입니다.</span>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="price ">원가 <span class="text-danger">*</span></label>
                                    <input class="form-control" type="number" placeholder="원가" name="price" id="price" value="{{ product.price }}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="thumbnail">상품 이미지 <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" name="thumbnail" id="thumbnail" multiple>
                                            <label class="custom-file-label" for="thumbnail">Choose file</label>
                                        </div>
                                    </div>
                                    <span class="font-13 text-muted">여러 이미지를 등록할 수 있습니다.</span>
                                    <div id="fileList" class="mt-2">
                                        {% if product.ProductImages %}
                                        <div class="media border p-2">
                                            {% for image in product.ProductImages %}
                                                <div style="width: 65px;height: 65px;margin-right: 5px;border: 1px solid #ddd;cursor:pointer;" onclick="deleteFile({{ image.id }}, {{loop.index - 1}});">
                                                    <img src="/{{ image.path }}" alt="" style="width: 100%;height: 100%;object-fit: cover;">
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="memo">상점 메모</label>
                                    <textarea class="form-control" name="memo" id="memo" style="height: 150px;">{{ product.memo }}</textarea>
                                    <span class="font-13 text-muted">상품에 대한 메모입니다. 고객에게 노출되지 않습니다.</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="example-textarea">상품 상세내용</label>
                                    <div id="" class="textEditor"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="description">상품 소개</label>
                                    <input class="form-control" type="text" placeholder="상품 소개글" name="description" id="description" value="{{ product.description }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="maker">제조사</label>
                                    <input class="form-control" type="text" placeholder="제조사" name="maker" id="maker" value="{{ product.maker }}">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="originplace">원산지</label>
                                    <input class="form-control" type="text" placeholder="원산지" name="originplace" id="originplace" value="{{ product.origin }}">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="brand">브랜드</label>
                                    <input class="form-control" type="text" placeholder="브랜드" name="brand" id="brand" value="{{ product.brand }}">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="model">모델</label>
                                    <input class="form-control" type="text" placeholder="모델" name="model" id="model" value="{{ product.model }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="use">상품 노출</label>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" name="use" id="use" {% if product.use %} checked {% endif %}>
                                        <label class="custom-control-label" for="use" >상품 노출여부</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="sold_out">품절</label>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" name="sold_out" id="sold_out" {% if product.sold_out %} checked {% endif %}>
                                        <label class="custom-control-label" for="sold_out">품절 여부</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex align-items-center">
                                    <label for="">상품 옵션관리</label>
                                    <button type="button" class="btn btn-primary addOptionItem" style="margin-left: auto;">상품옵션 추가</button>
                                </div>
                                <div id="optionList" class="optionList mt-2">
                                    {% for productOption in product.ProductOptions %}
                                    <div class="card optionItem" id="optionItem{{ productOption.id }}">
                                        <input type="hidden" name="optionItemId" value="{{ productOption.id }}">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-3">
                                                    <div class="form-group">
                                                        <label for="billing-email-address">옵션제목</label>
                                                        <input class="form-control" type="text" placeholder="상품 소개글" name="option_name" value="{{ productOption.name }}">
                                                        <span class="font-13 text-muted">ex) 컬러, 사이즈 등</span>
                                                    </div>
                                                </div>
                                                <div class="col-9">
                                                    <label for="">옵션별 상세</label>
                                                    <div class="optionListDetail">
                                                        {% for option in productOption.ProductOptionDetails %}
                                                        <div class="row" id="row{{ option.id }}">
                                                            <input type="hidden" name="option_id" value="{{ option.id }}">
                                                            <div class="col-5">
                                                                <div class="form-group">
                                                                    <input class="form-control" type="text" placeholder="옵션명" name="option_name" value="{{ option.name }}">
                                                                </div>
                                                            </div>
                                                            <div class="col-3">
                                                                <div class="form-group">
                                                                    <div class="input-group">
                                                                        <div class="custom-file">
                                                                            <input type="file" class="custom-file-input option_thumbnail" name="option_thumbnail">
                                                                            <input type="hidden" name="option_thumbnail_path" value="{{ option.path }}">
                                                                            <label class="custom-file-label" for="option_thumbnail">{{ option.path }}</label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-3">
                                                                <div class="form-group">
                                                                    <input class="form-control" type="text" placeholder="가격" name="option_price" value="{{ option.price }}">
                                                                </div>
                                                            </div>
                                                            <div class="col-1">
                                                                <button type="button" class="btn btn-outline-danger" onclick="deleteOptionDetail({{ option.id }}, {{ loop.index - 1 }});">삭제</button>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    <button type="button" class="btn btn-primary addOptionDetailRow" style="margin-left: auto;">옵션별 상세 추가</button>
                                                    <button type="button" class="btn btn-danger" style="margin-left: auto;" onclick="deleteOption({{ productOption.id }});">옵션 삭제</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="mt-3 d-flex">
                            <a href="/adm/product" class="btn btn-secondary">뒤로가기</a>
                            <button type="button" id="delete" class="btn btn-danger ml-auto mr-1">삭제</button>
                            <button type="submit" class="btn btn-primary">저장</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block css %}
<link href="/static/admin/css/vendor/summernote-bs4.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block script %}
<script src="/static/admin/js/vendor/summernote-bs4.min.js"></script>
<script src="/static/admin/js/vendor/summernote-ko-KR.min.js"></script>
<script>
  var filesTempArr = [];
  $(function(){

    if($('[name="category1"]').val()) {
      var that = $('[name="category1"]');
      $.ajax({
        type: "GET",
        url: "/adm/category/child",
        data: {
          id: that.val(),
        },
      }).done(function (res) {
        if (res.success) {
          var options = '<option value="">선택</option>';
          res.objects.map(function (data) {
            var selected = '';
            if (data.id === parseInt('{{ product.Categories[1].id or '-' }}')) {
              selected = 'selected';
            }
            options +=
              '<option value="' + data.id + '" '+ selected +'>' + data.name + "</option>";
          });
          var nextSelector = that.data("next");
          $(nextSelector).html(options);

          if($('[name="category2"]').val()) {
            var that2 = $('[name="category2"]');
            $.ajax({
              type: "GET",
              url: "/adm/category/child",
              data: {
                id: that2.val(),
              },
            }).done(function (res) {
              if (res.success) {
                var options = '<option value="">선택</option>';
                res.objects.map(function (data) {
                  console.log(data, {{ product.Categories[2].id }});
                  var selected = '';
                  if (data.id === parseInt('{{ product.Categories[2].id or '-' }}')) {
                    selected = 'selected';
                  }
                  options +=
                    '<option value="' + data.id + '" '+ selected +'>' + data.name + "</option>";
                });
                var nextSelector = that2.data("next");
                $(nextSelector).html(options);
              } else {
                alert("하위 카테고리 불러오기 실패");
              }
            });
          }
        } else {
          alert("하위 카테고리 불러오기 실패");
        }
      });
    }



    $('.textEditor').eq(0).summernote('code', '{{ product.content | safe }}')
    $(document).on('change', '.option_thumbnail', function(e){
      fileUploadForGetPath(e.target.files[0], this);
    });
    $('#delete').on('click', function(){
      if(confirm('삭제 하시겠습니까?')) {
        $.ajax({
          url: '/adm/product/remove/{{ product.id }}',
          type: 'post',
        }).done(function(res) {
          if(res.success) {
            alert('삭제 되었습니다.')
            location.href = '/adm/product'
          }
        }).fail(function(err){
          console.log(err);
        })
      }
    });

    $('#form').submit(function(e){
      e.preventDefault();
      var content = $('.textEditor').eq(0).summernote('code');
      var formData = new FormData();
      formData.append('category1', category1.value);
      formData.append('category2', category2.value);
      formData.append('category3', category3.value);
      formData.append('name', title.value);
      formData.append('price', price.value);
      formData.append('customer_price', customer_price.value);
      console.log(filesTempArr);
      for(var i=0, filesTempArrLen = filesTempArr.length; i<filesTempArrLen; i++) {
        formData.append("thumbnail", filesTempArr[i]);
      }
      formData.append('memo', memo.value);
      formData.append('content', content);
      formData.append('description', description.value);
      formData.append('maker', maker.value);
      formData.append('origin', originplace.value);
      formData.append('brand', brand.value);
      formData.append('model', model.value);
      if($('#use').is(':checked')) {
        formData.append('use', 'on');
      } else {
        formData.append('use', 'off');
      }
      if($('#sold_out').is(':checked')) {
        formData.append('sold_out', 'on');
      } else {
        formData.append('sold_out', 'off');
      }

      var optionsArr = [];
      $('.optionItem').each(function(){
        var optionObj = {};
        optionObj.id = $(this).find('[name="optionItemId"]').val();
        optionObj.name = $(this).find('[name="option_name"]').val();
        optionObj.list = [];
        $(this).find('.optionListDetail .row').each(function(){
          var optionDetailObj = {};
          optionDetailObj.id = $(this).find('[name="option_id"]').val();
          optionDetailObj.name = $(this).find('[name="option_name"]').val();
          optionDetailObj.path = $(this).find('[name="option_thumbnail_path"]').val();
          optionDetailObj.price = $(this).find('[name="option_price"]').val();
          optionObj.list.push(optionDetailObj);
        })
        optionsArr.push(optionObj);
      });
      formData.append('optionInfo', JSON.stringify(optionsArr));

      var url = '{{ product.name }}' === '' ? '/adm/product/create' : '/adm/product/detail/{{ product.id }}';
      $.ajax({
        url: url,
        type: 'post',
        data: formData,
        contentType: false,
        processData: false,
      }).done(function(data){
        if(data.success) {
          alert('등록이 완료되었습니다.');
          location.href="/adm/product/detail/"+data.id
        }
      }).fail(function(error) {
        console.error(error);
      })
    });

    $(document).on('click', '.addOptionDetailRow', function(){
      $(this).parents('.optionItem').find('.optionListDetail').append('' +
        '<div class="row">\n' +
        '                                                            <div class="col-5">\n' +
        '                                                                <div class="form-group">\n' +
        '                                                                    <input class="form-control" type="text" placeholder="옵션명" name="option_name">\n' +
        '                                                                </div>\n' +
        '                                                            </div>\n' +
        '                                                            <div class="col-3">\n' +
        '                                                                <div class="form-group">\n' +
        '                                                                    <div class="input-group">\n' +
        '                                                                        <div class="custom-file">\n' +
        '                                                                            <input type="file" class="custom-file-input option_thumbnail" name="option_thumbnail">\n' +
        '                                                                            <input type="hidden" name="option_thumbnail_path" value="">\n' +
        '                                                                            <label class="custom-file-label" for="option_thumbnail">상품 이미지</label>\n' +
        '                                                                        </div>\n' +
        '                                                                    </div>\n' +
        '                                                                </div>\n' +
        '                                                            </div>\n' +
        '                                                            <div class="col-3">\n' +
        '                                                                <div class="form-group">\n' +
        '                                                                    <input class="form-control" type="text" placeholder="가격" name="option_price">\n' +
        '                                                                </div>\n' +
        '                                                            </div>\n' +
        '                                                        </div>');
    })

    $('.addOptionItem').on('click', function(){
      $('#optionList').append('\n' +
        '                                    <div class="card optionItem">\n' +
        '                                        <div class="card-body">\n' +
        '                                            <div class="row">\n' +
        '                                                <div class="col-3">\n' +
        '                                                    <div class="form-group">\n' +
        '                                                        <label for="billing-email-address">옵션제목</label>\n' +
        '                                                        <input class="form-control" type="text" placeholder="상품 소개글" name="option_name">\n' +
        '                                                        <span class="font-13 text-muted">ex) 컬러, 사이즈 등</span>\n' +
        '                                                    </div>\n' +
        '                                                </div>\n' +
        '                                                <div class="col-9">\n' +
        '                                                    <label for="">옵션별 상세</label>\n' +
        '                                                    <div class="optionListDetail">\n' +
        '                                                        <div class="row">\n' +
        '                                                            <div class="col-5">\n' +
        '                                                                <div class="form-group">\n' +
        '                                                                    <input class="form-control" type="text" placeholder="옵션명" name="option_name">\n' +
        '                                                                </div>\n' +
        '                                                            </div>\n' +
        '                                                            <div class="col-3">\n' +
        '                                                                <div class="form-group">\n' +
        '                                                                    <div class="input-group">\n' +
        '                                                                        <div class="custom-file">\n' +
        '                                                                            <input type="file" class="custom-file-input option_thumbnail" name="option_thumbnail">\n' +
        '                                                                            <input type="hidden" name="option_thumbnail_path" value="">\n' +
        '                                                                            <label class="custom-file-label" for="option_thumbnail">상품 이미지</label>\n' +
        '                                                                        </div>\n' +
        '                                                                    </div>\n' +
        '                                                                </div>\n' +
        '                                                            </div>\n' +
        '                                                            <div class="col-3">\n' +
        '                                                                <div class="form-group">\n' +
        '                                                                    <input class="form-control" type="text" placeholder="가격" name="option_price">\n' +
        '                                                                </div>\n' +
        '                                                            </div>\n' +
        '                                                        </div>\n' +
        '                                                    </div>\n' +
        '                                                    <button type="button" class="btn btn-primary addOptionDetailRow" style="margin-left: auto;">옵션별 상세 추가</button>\n' +
        '                                                </div>\n' +
        '                                            </div>\n' +
        '                                        </div>\n' +
        '                                    </div>')
    });
  })

  $(document).ready(function() {
    $("#thumbnail").on("change", addFiles);
  });

  function addFiles(e) {
    var files = e.target.files;
    var filesArr = Array.prototype.slice.call(files);
    var filesArrLen = filesArr.length;
    var filesTempArrLen = filesTempArr.length;
    for( var i=0; i<filesArrLen; i++ ) {
      filesTempArr.push(filesArr[i]);
    }
  }

  function deleteFile (id, idx) {
    if( !confirm('이미지를 삭제 하시겠습니까?') ) {
      return false;
    }
    $.ajax({
      url: '/adm/product/image/delete/' + id,
      type: 'post',
      contentType: false,
      processData: false,
    }).done(function(data){
      if(data.success) {
        alert('이미지가 삭제되었습니다.');
        $('#fileList .media div').eq(idx).remove();
      }
    }).fail(function(error) {
      console.error(error);
    });
  }

  function deleteOption(id) {
    if( !confirm('옵션을 삭제 하시겠습니까?') ) {
      return false;
    }
    $.ajax({
      url: '/adm/product/option/delete/' + id,
      type: 'post',
      contentType: false,
      processData: false,
    }).done(function(data){
      if(data.success) {
        alert('옵션이 삭제되었습니다.');
        $('#optionItem' + id).remove();
      }
    }).fail(function(error) {
      console.error(error);
    });
  }

  function deleteOptionDetail(id) {
    if( !confirm('옵션을 삭제 하시겠습니까?') ) {
      return false;
    }
    $.ajax({
      url: '/adm/product/optionDetail/delete/' + id,
      type: 'post',
      contentType: false,
      processData: false,
    }).done(function(data){
      if(data.success) {
        alert('옵션이 삭제되었습니다.');
        $('#row' + id).remove();
      }
    }).fail(function(error) {
      console.error(error);
    });
  }
</script>
{% endblock %}
